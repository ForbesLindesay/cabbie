version: 2

refs:
  - &container
    docker:
      - image: node:8.11
    working_directory: ~/repo
  - &npm_auth
    run:
      name: NPM Auth
      command: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
  - &install
    run:
      name: Yarn Install
      command: yarn --frozen-lockfile
  - &build
    run:
      name: Build
      command: yarn build
  - &test_async
    run:
      name: Test Async (TypeScript)
      command: yarn test:async:replay
  - &test_sync
    run:
      name: Test Sync (TypeScript)
      command: yarn test:sync:replay
  - &test_async_flow
    run:
      name: Test Async (Flow)
      command: yarn test:async:flow:replay
  - &test_sync_flow
    run:
      name: Test Sync (Flow)
      command: yarn test:sync:flow:replay

jobs:
  all:
    <<: *container
    steps:
      - checkout
      - *npm_auth
      - *install
      - *build
      - *test_async
      - *test_sync
      - *test_async_flow
      - *test_sync_flow

  master:
    <<: *container
    steps:
      - checkout
      - *npm_auth
      - *install
      - *build
      - *test_async
      - *test_sync
      - *test_async_flow
      - *test_sync_flow

workflows:
  version: 2
  all:
    jobs:
      - all:
          filters:
            branches:
              ignore:
                - master
  master:
    jobs:
      - master:
          filters:
            branches:
              only: master
